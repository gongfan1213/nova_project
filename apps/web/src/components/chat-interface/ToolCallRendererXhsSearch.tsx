// startCall.tool_input
// endCall.observation
// {"xhsSearch": "{\"doc\": [{\"auther_home_page_url\": \"https://www.xiaohongshu.com/user/profile/67473520000000001d02f748\", \"note_cover_url_default\": \"http://sns-webpic-qc.xhscdn.com/202506162140/aff9de1a6406b69e0552307c4d6008cc/1040g00831bbeo1kvni7g5pj9gu90ublk02k69d0!nc_n_webp_mw_1\", \"note_display_title\": \"云南5天4晚大理丽江-纯玩攻略\", \"note_url\": \"https://www.xiaohongshu.com/explore/675c30c5000000000700b45a?xsec_token=ABPiqsNnAERnkwWEpBMu3iqf9BFEL_2s9MxOPt_3Tlahs=\"}, {\"auther_home_page_url\": \"https://www.xiaohongshu.com/user/profile/57f60ad450c4b442bca73cef\", \"note_cover_url_default\": \"http://sns-webpic-qc.xhscdn.com/202506162140/cdb0dce53b25e0f60dc1b88728e980e7/1040g2sg31igf884ggce048o7mt5d8f7f2lhptdo!nc_n_webp_mw_1\", \"note_display_title\": \"我的川西记忆\", \"note_url\": \"https://www.xiaohongshu.com/explore/6846709f0000000021006c14?xsec_token=ABmBZAJ8iho7xVV79aU6hZlxliQllvpmw_j79rZYMTp1k=\"}, {\"auther_home_page_url\": \"https://www.xiaohongshu.com/user/profile/5688f2fdb8ce1a26ed7b0aff\", \"note_cover_url_default\": \"http://sns-webpic-qc.xhscdn.com/202506162140/e2c7c02a14f39324d65e64514fac0168/1040g00831gtahmrlj80044vi99pfq2nv58kc5j8!nc_n_webp_mw_1\", \"note_display_title\": \"日本｜富士山🗻山中湖绝美粉色日出平野之浜\", \"note_url\": \"https://www.xiaohongshu.com/explore/68120edc000000002301d3de?xsec_token=ABufMp-1CfSHptA6OTkgsd2qs0dEvxZO0SMCFaSgjCyH0=\"}, {\"auther_home_page_url\": \"https://www.xiaohongshu.com/user/profile/62c6663a000000000303eb5a\", \"note_cover_url_default\": \"http://sns-webpic-qc.xhscdn.com/202506162140/f327819b5adfa7e5ab97b3d33bccf31e/notes_pre_post/1040g3k031i8uk8ci6q005om6cot0vqqq64kksvo!nc_n_webp_mw_1\", \"note_display_title\": \"目前旅游最满意的城市是哪个？\", \"note_url\": \"https://www.xiaohongshu.com/explore/683ebbc8000000002301ce16?xsec_token=ABPQsa1GbLhEMDYZGkBCHyMwOuDuJ1Yvh3TmW0Kjp53TY=\"}, {\"auther_home_page_url\": \"https://www.xiaohongshu.com/user/profile/5d74ac1d0000000001000549\", \"note_cover_url_default\": \"http://sns-webpic-qc.xhscdn.com/202506162140/2654b600dfaaf875adf27dc70e721f60/1040g00831i783a0r70005nbklgeg81a9sqqttj8!nc_n_webp_mw_1\", \"note_display_title\": \"live图 不敢相信，草原的尽头是大海～\", \"note_url\": \"https://www.xiaohongshu.com/explore/683c7bd400000000200290fa?xsec_token=ABt26rlfLzvPSLm0JcLc-U2kYQMy38iE5ibQmEJ4mZV14=\"}]}{\"doc\": [{\"auther_home_page_url\": \"https://www.xiaohongshu.com/user/profile/67473520000000001d02f748\", \"note_cover_url_default\": \"http://sns-webpic-qc.xhscdn.com/202506162140/aff9de1a6406b69e0552307c4d6008cc/1040g00831bbeo1kvni7g5pj9gu90ublk02k69d0!nc_n_webp_mw_1\", \"note_display_title\": \"云南5天4晚大理丽江-纯玩攻略\", \"note_url\": \"https://www.xiaohongshu.com/explore/675c30c5000000000700b45a?xsec_token=ABPiqsNnAERnkwWEpBMu3iqf9BFEL_2s9MxOPt_3Tlahs=\"}, {\"auther_home_page_url\": \"https://www.xiaohongshu.com/user/profile/57f60ad450c4b442bca73cef\", \"note_cover_url_default\": \"http://sns-webpic-qc.xhscdn.com/202506162140/cdb0dce53b25e0f60dc1b88728e980e7/1040g2sg31igf884ggce048o7mt5d8f7f2lhptdo!nc_n_webp_mw_1\", \"note_display_title\": \"我的川西记忆\", \"note_url\": \"https://www.xiaohongshu.com/explore/6846709f0000000021006c14?xsec_token=ABmBZAJ8iho7xVV79aU6hZlxliQllvpmw_j79rZYMTp1k=\"}, {\"auther_home_page_url\": \"https://www.xiaohongshu.com/user/profile/5688f2fdb8ce1a26ed7b0aff\", \"note_cover_url_default\": \"http://sns-webpic-qc.xhscdn.com/202506162140/e2c7c02a14f39324d65e64514fac0168/1040g00831gtahmrlj80044vi99pfq2nv58kc5j8!nc_n_webp_mw_1\", \"note_display_title\": \"日本｜富士山🗻山中湖绝美粉色日出平野之浜\", \"note_url\": \"https://www.xiaohongshu.com/explore/68120edc000000002301d3de?xsec_token=ABufMp-1CfSHptA6OTkgsd2qs0dEvxZO0SMCFaSgjCyH0=\"}, {\"auther_home_page_url\": \"https://www.xiaohongshu.com/user/profile/62c6663a000000000303eb5a\", \"note_cover_url_default\": \"http://sns-webpic-qc.xhscdn.com/202506162140/f327819b5adfa7e5ab97b3d33bccf31e/notes_pre_post/1040g3k031i8uk8ci6q005om6cot0vqqq64kksvo!nc_n_webp_mw_1\", \"note_display_title\": \"目前旅游最满意的城市是哪个？\", \"note_url\": \"https://www.xiaohongshu.com/explore/683ebbc8000000002301ce16?xsec_token=ABPQsa1GbLhEMDYZGkBCHyMwOuDuJ1Yvh3TmW0Kjp53TY=\"}, {\"auther_home_page_url\": \"https://www.xiaohongshu.com/user/profile/5d74ac1d0000000001000549\", \"note_cover_url_default\": \"http://sns-webpic-qc.xhscdn.com/202506162140/2654b600dfaaf875adf27dc70e721f60/1040g00831i783a0r70005nbklgeg81a9sqqttj8!nc_n_webp_mw_1\", \"note_display_title\": \"live图 不敢相信，草原的尽头是大海～\", \"note_url\": \"https://www.xiaohongshu.com/explore/683c7bd400000000200290fa?xsec_token=ABt26rlfLzvPSLm0JcLc-U2kYQMy38iE5ibQmEJ4mZV14=\"}]}"}

import React from 'react'
import { Card, CardContent } from '@/components/ui/card'
import { ExternalLink } from 'lucide-react'

interface XhsNote {
  auther_home_page_url: string
  note_cover_url_default: string
  note_display_title: string
  note_url: string
}

interface XhsSearchResult {
  doc: XhsNote[]
}

export const ToolCallRendererXhsSearch = ({
  startCall,
  endCall,
}: {
  startCall: any
  endCall: any
}) => {
  const output = JSON.parse(endCall.observation)
  try {
  const doc = JSON.parse(output.xhsSearch);
  console.log("doc", doc);
  } catch (error) {
    console.log("error", error);
  }
  console.log("output", output.xhsSearch);
  
  return <div className="">
    {JSON.parse(endCall.observation).xhsSearch}
  </div>
  // 解析观察数据
  const parseXhsData = (): XhsNote[] => {
    try {
      if (!endCall?.observation) return []
      
      // 直接从观察文本中提取 JSON 数据
      const observationText = endCall.observation
      
      // 寻找第一个完整的 JSON 对象
      const startIndex = observationText.indexOf('{"doc":')
      if (startIndex === -1) return []
      
      // 找到第一个完整的 doc 数组结束位置
      let bracketCount = 0
      let endIndex = startIndex
      for (let i = startIndex; i < observationText.length; i++) {
        if (observationText[i] === '{') bracketCount++
        if (observationText[i] === '}') bracketCount--
        if (bracketCount === 0) {
          endIndex = i + 1
          break
        }
      }
      
      const jsonStr = observationText.substring(startIndex, endIndex)
      const parsedData = JSON.parse(jsonStr) as XhsSearchResult
      
      return parsedData.doc || []
    } catch (error) {
      console.error('解析小红书数据失败:', error)
      // 备用解析方式
      try {
        const observationText = endCall.observation
        const match = observationText.match(/\{"doc":\s*\[.*?\]\}/)
        if (match) {
          const parsedData = JSON.parse(match[0]) as XhsSearchResult
          return parsedData.doc || []
        }
      } catch (e) {
        console.error('备用解析也失败:', e)
      }
      return []
    }
  }

  const notes = parseXhsData().slice(0, 3) // 只取前三篇

  if (notes.length === 0) {
    return (
      <div className="text-center py-8 text-gray-500">
        暂无搜索结果
      </div>
    )
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center gap-2 mb-4">
        <div className="w-6 h-6 bg-gradient-to-r from-pink-500 to-red-500 rounded-full flex items-center justify-center">
          <span className="text-white text-xs font-bold">小</span>
        </div>
        <h3 className="text-lg font-semibold text-gray-800">小红书搜索结果</h3>
      </div>
      
      <div className="grid gap-4 md:grid-cols-3">
        {notes.map((note, index) => (
          <Card key={index} className="group hover:shadow-lg transition-all duration-300 overflow-hidden border-0 shadow-md">
            <div className="relative">
              <img
                src={note.note_cover_url_default}
                alt={note.note_display_title}
                className="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300"
                onError={(e) => {
                  const target = e.target as HTMLImageElement
                  target.src = '/placeholder-image.jpg' // 设置默认图片
                }}
              />
              <div className="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300" />
            </div>
            
            <CardContent className="p-4">
              <h4 className="font-medium text-gray-800 line-clamp-2 leading-tight mb-3 group-hover:text-pink-600 transition-colors">
                {note.note_display_title}
              </h4>
              
              <div className="flex items-center justify-between">
                <a
                  href={note.note_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="inline-flex items-center gap-1 text-sm text-pink-600 hover:text-pink-700 font-medium transition-colors"
                >
                  查看原文
                  <ExternalLink className="w-3 h-3" />
                </a>
                
                <a
                  href={note.auther_home_page_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-xs text-gray-500 hover:text-gray-700 transition-colors"
                >
                  作者主页
                </a>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
      
      {notes.length < 3 && (
        <p className="text-sm text-gray-500 text-center mt-4">
          共找到 {notes.length} 篇相关内容
        </p>
      )}
    </div>
  )
}