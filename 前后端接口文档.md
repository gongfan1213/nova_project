 # Open Canvas å‰åç«¯æ¥å£æ–‡æ¡£

## 1. é¡¹ç›®æ¶æ„æ¦‚è¿°

Open Canvas æ˜¯ä¸€ä¸ªåŸºäº **LangGraph** å’Œ **Next.js** çš„å…¨æ ˆåº”ç”¨ï¼Œé‡‡ç”¨ä»¥ä¸‹æ¶æ„ï¼š

- **å‰ç«¯**: Next.js (apps/web) - ç”¨æˆ·ç•Œé¢å’Œå®¢æˆ·ç«¯é€»è¾‘
- **åç«¯**: LangGraph Server (apps/agents) - AIä»£ç†å’Œå·¥ä½œæµå¼•æ“
- **ä»£ç†å±‚**: Next.js API Routes - ä½œä¸ºå‰ç«¯å’ŒLangGraphä¹‹é—´çš„ä»£ç†
- **æ•°æ®å­˜å‚¨**: Supabase - ç”¨æˆ·è®¤è¯å’Œæ•°æ®æŒä¹…åŒ–
- **AIæ¨¡å‹**: æ”¯æŒå¤šç§LLMæä¾›å•†ï¼ˆOpenAIã€Anthropicã€Fireworksç­‰ï¼‰

## 2. é€šä¿¡æ¶æ„

```
å‰ç«¯ (React) 
    â†“ HTTP/WebSocket
Next.js API Routes (ä»£ç†å±‚)
    â†“ HTTP + LangGraph SDK
LangGraph Server (AIåç«¯)
    â†“ AIå·¥å…·è°ƒç”¨
å¤–éƒ¨AIæœåŠ¡ (OpenAI/Anthropicç­‰)
```

## 3. æ ¸å¿ƒæ¥å£å®šä¹‰

### 3.1 ä¸»è¦æµå¼é€šä¿¡æ¥å£

#### 3.1.1 æµå¼æ¶ˆæ¯å¤„ç† (æ ¸å¿ƒæ¥å£)

**è¯·æ±‚è·¯å¾„**: `POST /api/runs/{thread_id}/stream`

**é€šä¿¡æ–¹å¼**: 
- å‰ç«¯é€šè¿‡ Web Worker å‘èµ·æµå¼è¯·æ±‚
- ä½¿ç”¨ LangGraph SDK çš„ `client.runs.stream()` æ–¹æ³•
- é‡‡ç”¨ Server-Sent Events (SSE) è¿›è¡Œå®æ—¶æ•°æ®ä¼ è¾“

## 4. äº¤äº’æ¨¡å¼è¯¦è§£

Open Canvas æ”¯æŒå¤šç§äº¤äº’æ¨¡å¼ï¼Œç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·çš„æ“ä½œç±»å‹å’Œå½“å‰çŠ¶æ€è‡ªåŠ¨è·¯ç”±åˆ°ç›¸åº”çš„å¤„ç†èŠ‚ç‚¹ï¼š

### 4.1 äº¤äº’æ¨¡å¼åˆ†ç±»

#### 4.1.1 **ç¬¬ä¸€æ¬¡ç”Ÿæˆå†…å®¹** (`generateArtifact`)
**è§¦å‘æ¡ä»¶**: 
- å½“å‰æ²¡æœ‰å·¥ä»¶å­˜åœ¨
- ç”¨æˆ·è¯·æ±‚ç”Ÿæˆæ–°çš„æ–‡æ¡£æˆ–ä»£ç 

**è·¯ç”±é€»è¾‘**: 
```typescript
// åœ¨generatePathèŠ‚ç‚¹ä¸­åˆ¤æ–­
if (!state.artifact && userRequestsNewContent) {
  return { next: "generateArtifact" }
}
```

**ä¼ å…¥å‚æ•°**:
```typescript
{
  messages: [ç”¨æˆ·æ¶ˆæ¯å†å²],
  artifact: undefined,  // æ²¡æœ‰ç°æœ‰å·¥ä»¶
  webSearchEnabled?: boolean,
  // å…¶ä»–åˆ›å»ºå‚æ•°...
}
```

#### 4.1.2 **é‡å†™æ•´ä¸ªå·¥ä»¶** (`rewriteArtifact`) 
**è§¦å‘æ¡ä»¶**:
- å·²å­˜åœ¨å·¥ä»¶
- ç”¨æˆ·è¦æ±‚å¯¹æ•´ä¸ªå·¥ä»¶è¿›è¡Œä¿®æ”¹æˆ–ç”Ÿæˆå®Œå…¨ä¸åŒçš„å†…å®¹

**è·¯ç”±é€»è¾‘**:
```typescript
// AIåŠ¨æ€åˆ¤æ–­ç”¨æˆ·æ„å›¾
if (state.artifact && userWantsToRewriteEntireArtifact) {
  return { next: "rewriteArtifact" }
}
```

**ä¼ å…¥å‚æ•°**:
```typescript
{
  messages: [ç”¨æˆ·æ–°çš„ä¿®æ”¹è¯·æ±‚],
  artifact: {ç°æœ‰å·¥ä»¶å®Œæ•´ç»“æ„},
  // å¯èƒ½åŒ…å«ä¿®æ”¹æŒ‡ä»¤å‚æ•°
}
```

#### 4.1.3 **é€‰ä¸­å†…å®¹å±€éƒ¨ç¼–è¾‘** 
æ ¹æ®é€‰ä¸­å†…å®¹ç±»å‹åˆ†ä¸ºä¸¤ç§ï¼š

##### A. ä»£ç ç‰‡æ®µç¼–è¾‘ (`updateArtifact`)
**è§¦å‘æ¡ä»¶**: 
- ç”¨æˆ·åœ¨ä»£ç ç¼–è¾‘å™¨ä¸­é€‰ä¸­äº†ä¸€æ®µä»£ç 
- æäº¤ç¼–è¾‘è¯·æ±‚

**è·¯ç”±é€»è¾‘**:
```typescript
if (state.highlightedCode) {
  return { next: "updateArtifact" }
}
```

**ä¼ å…¥å‚æ•°**:
```typescript
{
  messages: [ç”¨æˆ·çš„ç¼–è¾‘æŒ‡ä»¤],
  artifact: {å½“å‰å·¥ä»¶},
  highlightedCode: {
    startCharIndex: 100,  // é€‰ä¸­å¼€å§‹ä½ç½®
    endCharIndex: 250     // é€‰ä¸­ç»“æŸä½ç½®
  }
}
```

**æ•°æ®è·å–è¿‡ç¨‹**:
1. ç”¨æˆ·åœ¨CodeRendererç»„ä»¶ä¸­é€‰ä¸­ä»£ç 
2. é€šè¿‡`editorRef.current.posAtDOM()`è·å–é€‰ä¸­èŒƒå›´
3. è®¡ç®—å­—ç¬¦ç´¢å¼•ä½ç½®
4. å­˜å‚¨åˆ°`selectionIndexes`çŠ¶æ€ä¸­

##### B. æ–‡æœ¬ç‰‡æ®µç¼–è¾‘ (`updateHighlightedText`)
**è§¦å‘æ¡ä»¶**:
- ç”¨æˆ·åœ¨markdownç¼–è¾‘å™¨ä¸­é€‰ä¸­äº†æ–‡æœ¬
- æäº¤ç¼–è¾‘è¯·æ±‚

**è·¯ç”±é€»è¾‘**:
```typescript
if (state.highlightedText) {
  return { next: "updateHighlightedText" }
}
```

**ä¼ å…¥å‚æ•°**:
```typescript
{
  messages: [ç”¨æˆ·çš„ç¼–è¾‘æŒ‡ä»¤],
  artifact: {å½“å‰å·¥ä»¶},
  highlightedText: {
    fullMarkdown: "å®Œæ•´çš„markdownæ–‡æœ¬",
    markdownBlock: "é€‰ä¸­çš„markdownå—",
    selectedText: "å®é™…é€‰ä¸­çš„æ–‡æœ¬å†…å®¹"
  }
}
```

#### 4.1.4 **å¿«æ·æ“ä½œæ¨¡å¼**

##### A. å†…ç½®å¿«æ·æ“ä½œ
**æ–‡æœ¬ç±»å¿«æ·æ“ä½œ** (`rewriteArtifactTheme`):
- æ”¹å˜è¯­è¨€ã€é•¿åº¦ã€é˜…è¯»éš¾åº¦ã€æ·»åŠ è¡¨æƒ…ç¬¦å·

**è§¦å‘æ¡ä»¶**:
```typescript
if (state.language || state.artifactLength || 
    state.regenerateWithEmojis || state.readingLevel) {
  return { next: "rewriteArtifactTheme" }
}
```

**ä»£ç ç±»å¿«æ·æ“ä½œ** (`rewriteCodeArtifactTheme`):
- æ·»åŠ æ³¨é‡Šã€æ·»åŠ æ—¥å¿—ã€ä¿®å¤bugã€è½¬æ¢ç¼–ç¨‹è¯­è¨€

**è§¦å‘æ¡ä»¶**:
```typescript
if (state.addComments || state.addLogs || 
    state.portLanguage || state.fixBugs) {
  return { next: "rewriteCodeArtifactTheme" }
}
```

##### B. è‡ªå®šä¹‰å¿«æ·æ“ä½œ (`customAction`)
**è§¦å‘æ¡ä»¶**:
```typescript
if (state.customQuickActionId) {
  return { next: "customAction" }
}
```

**ä¼ å…¥å‚æ•°**:
```typescript
{
  messages: [ä¸Šä¸‹æ–‡æ¶ˆæ¯],
  artifact: {å½“å‰å·¥ä»¶},
  customQuickActionId: "uuid-of-custom-action"
}
```

#### 4.1.5 **çº¯å¯¹è¯æ¨¡å¼** (`replyToGeneralInput`)
**è§¦å‘æ¡ä»¶**:
- ç”¨æˆ·çš„è¾“å…¥ä¸æ¶‰åŠå·¥ä»¶æ“ä½œ
- çº¯ç²¹çš„é—®ç­”æˆ–èŠå¤©

**è·¯ç”±é€»è¾‘**:
```typescript
// AIåŠ¨æ€åˆ¤æ–­åç¡®å®šç”¨æˆ·åªæ˜¯æƒ³èŠå¤©
if (userJustWantsToChat && !artifactRelated) {
  return { next: "replyToGeneralInput" }
}
```

#### 4.1.6 **ç½‘ç»œæœç´¢å¢å¼ºæ¨¡å¼** (`webSearch`)
**è§¦å‘æ¡ä»¶**:
```typescript
if (state.webSearchEnabled) {
  return { next: "webSearch" }
}
```

### 4.2 å‰ç«¯äº¤äº’æµç¨‹è¯¦è§£

#### 4.2.1 æ–‡æœ¬/ä»£ç é€‰æ‹©æµç¨‹
1. **é€‰æ‹©æ£€æµ‹**: é€šè¿‡`mouseup`äº‹ä»¶ç›‘å¬ç”¨æˆ·é€‰æ‹©
2. **èŒƒå›´éªŒè¯**: ç¡®è®¤é€‰æ‹©åœ¨å·¥ä»¶å†…å®¹åŒºåŸŸå†…
3. **ç´¢å¼•è®¡ç®—**: 
   - ä»£ç : ä½¿ç”¨CodeMirrorçš„`posAtDOM()`
   - æ–‡æœ¬: åŸºäºDOMèŒƒå›´è®¡ç®—markdownä½ç½®
4. **UIæ˜¾ç¤º**: æ˜¾ç¤º`AskOpenCanvas`è¾“å…¥æ¡†
5. **æäº¤å¤„ç†**: ç”¨æˆ·è¾“å…¥æŒ‡ä»¤åè°ƒç”¨`streamMessage()`

#### 4.2.2 å¿«æ·æ“ä½œæµç¨‹  
1. **æ“ä½œè§¦å‘**: ç”¨æˆ·ç‚¹å‡»å·¥å…·æ æŒ‰é’®
2. **å‚æ•°è®¾ç½®**: æ ¹æ®æ“ä½œç±»å‹è®¾ç½®å¯¹åº”å‚æ•°
3. **è¯·æ±‚å‘é€**: è°ƒç”¨`streamMessage()`å¹¶ä¼ å…¥ç‰¹å®šå‚æ•°
4. **çŠ¶æ€æ›´æ–°**: å®æ—¶æ›´æ–°å·¥ä»¶å†…å®¹

#### 4.2.3 è‡ªå®šä¹‰å¿«æ·æ“ä½œæµç¨‹
1. **æ“ä½œåˆ›å»º**: ç”¨æˆ·åœ¨å¯¹è¯æ¡†ä¸­å®šä¹‰æç¤ºè¯å’Œé…ç½®
2. **å­˜å‚¨ä¿å­˜**: é€šè¿‡`/api/store/put`ä¿å­˜åˆ°åç«¯
3. **æ“ä½œæ‰§è¡Œ**: ç‚¹å‡»æ—¶ä¼ å…¥`customQuickActionId`
4. **ä¸Šä¸‹æ–‡æ³¨å…¥**: æ ¹æ®é…ç½®å†³å®šæ˜¯å¦åŒ…å«å†å²æ¶ˆæ¯å’Œåæ€å†…å®¹

### 4.3 äº¤äº’æ¨¡å¼æ€»è§ˆè¡¨

| äº¤äº’æ¨¡å¼ | åç«¯èŠ‚ç‚¹ | è§¦å‘æ¡ä»¶ | å…³é”®å‚æ•° | ç”¨é€”è¯´æ˜ | è¾“å‡ºä½ç½® |
|---------|---------|---------|---------|---------|---------|
| **é¦–æ¬¡ç”Ÿæˆ** | `generateArtifact` â†’ `generateFollowup` | æ— ç°æœ‰å·¥ä»¶ + ç”¨æˆ·è¯·æ±‚å†…å®¹ | `messages`, `webSearchEnabled` | åˆ›å»ºæ–°çš„æ–‡æ¡£æˆ–ä»£ç  | å·¥ä»¶â†’ç¼–è¾‘å™¨<br/>æç¤ºâ†’èŠå¤©æ¡† |
| **æ•´ä½“é‡å†™** | `rewriteArtifact` â†’ `generateFollowup` | æœ‰å·¥ä»¶ + AIåˆ¤æ–­ä¸ºé‡å†™æ„å›¾ | `messages`, `artifact` | å®Œå…¨é‡æ–°ç”Ÿæˆå·¥ä»¶å†…å®¹ | å·¥ä»¶â†’ç¼–è¾‘å™¨<br/>æç¤ºâ†’èŠå¤©æ¡† |
| **ä»£ç å±€éƒ¨ç¼–è¾‘** | `updateArtifact` â†’ `generateFollowup` | ç”¨æˆ·é€‰ä¸­ä»£ç ç‰‡æ®µ | `highlightedCode`, `messages` | ä¿®æ”¹é€‰ä¸­çš„ä»£ç éƒ¨åˆ† | å·¥ä»¶â†’ç¼–è¾‘å™¨<br/>æç¤ºâ†’èŠå¤©æ¡† |
| **æ–‡æœ¬å±€éƒ¨ç¼–è¾‘** | `updateHighlightedText` â†’ `generateFollowup` | ç”¨æˆ·é€‰ä¸­æ–‡æœ¬ç‰‡æ®µ | `highlightedText`, `messages` | ä¿®æ”¹é€‰ä¸­çš„æ–‡æœ¬éƒ¨åˆ† | å·¥ä»¶â†’ç¼–è¾‘å™¨<br/>æç¤ºâ†’èŠå¤©æ¡† |
| **æ–‡æœ¬ä¸»é¢˜è°ƒæ•´** | `rewriteArtifactTheme` â†’ `generateFollowup` | å¿«æ·æ“ä½œï¼šè¯­è¨€/é•¿åº¦/éš¾åº¦ç­‰ | `language`, `artifactLength`, `readingLevel` | è°ƒæ•´æ–‡æœ¬é£æ ¼å’Œå±æ€§ | å·¥ä»¶â†’ç¼–è¾‘å™¨<br/>æç¤ºâ†’èŠå¤©æ¡† |
| **ä»£ç åŠŸèƒ½å¢å¼º** | `rewriteCodeArtifactTheme` â†’ `generateFollowup` | å¿«æ·æ“ä½œï¼šæ³¨é‡Š/æ—¥å¿—/ä¿®å¤ç­‰ | `addComments`, `fixBugs`, `portLanguage` | å¢å¼ºä»£ç åŠŸèƒ½ | å·¥ä»¶â†’ç¼–è¾‘å™¨<br/>æç¤ºâ†’èŠå¤©æ¡† |
| **è‡ªå®šä¹‰æ“ä½œ** | `customAction` â†’ `generateFollowup` | ç”¨æˆ·è‡ªå®šä¹‰å¿«æ·æ“ä½œ | `customQuickActionId` | æ‰§è¡Œç”¨æˆ·é¢„è®¾çš„æ“ä½œ | å·¥ä»¶â†’ç¼–è¾‘å™¨<br/>æç¤ºâ†’èŠå¤©æ¡† |
| **çº¯å¯¹è¯** | `replyToGeneralInput` | AIåˆ¤æ–­ä¸ºéå·¥ä»¶ç›¸å…³ | `messages` | æ™®é€šèŠå¤©å¯¹è¯ | ä»…èŠå¤©æ¡† |
| **ç½‘ç»œæœç´¢** | `webSearch` â†’ `routePostWebSearch` | å¯ç”¨æœç´¢åŠŸèƒ½ | `webSearchEnabled` | æœç´¢ç½‘ç»œä¿¡æ¯å¢å¼ºå›ç­” | æœç´¢ç»“æœâ†’èŠå¤©æ¡†<br/>ç„¶åè·¯ç”±åˆ°å…¶ä»–èŠ‚ç‚¹ |

## 5. å„èŠ‚ç‚¹å‚æ•°è¯¦è§£

### 5.1 generateFollowup èŠ‚ç‚¹å‚æ•°

`generateFollowup` æ˜¯æ‰€æœ‰å·¥ä»¶æ“ä½œå®Œæˆåçš„å¿…ç»èŠ‚ç‚¹ï¼Œè´Ÿè´£ç”Ÿæˆç”¨æˆ·å‹å¥½çš„å®Œæˆæç¤ºã€‚

#### 5.1.1 è¾“å…¥å‚æ•°
| å‚æ•°å | ç±»å‹ | æ¥æº | è¯´æ˜ |
|--------|------|------|------|
| `artifactContent` | `string \| undefined` | `state.artifact` | å½“å‰å·¥ä»¶çš„æ–‡æœ¬å†…å®¹ï¼ˆä»£ç æˆ–markdownï¼‰ |
| `conversation` | `string` | `state._messages` | æ ¼å¼åŒ–çš„å¯¹è¯å†å²ï¼Œç”¨XMLæ ‡ç­¾åŒ…è£… |
| `reflections` | `string` | å­˜å‚¨ç³»ç»Ÿ | ç”¨æˆ·åå¥½ã€é£æ ¼è§„åˆ™ç­‰ä¸ªæ€§åŒ–è®°å¿† |
| `assistantId` | `string` | `config.configurable` | åŠ©æ‰‹IDï¼Œç”¨äºæ£€ç´¢ç”¨æˆ·ä¸“å±è®°å¿† |

#### 5.1.2 å¤„ç†é€»è¾‘
```typescript
export const generateFollowup = async (
  state: typeof OpenCanvasGraphAnnotation.State,
  config: LangGraphRunnableConfig
): Promise<OpenCanvasGraphReturnType> => {
  // 1. è·å–å°æ¨¡å‹ï¼ˆå¿«é€Ÿå“åº”ï¼‰
  const smallModel = await getModelFromConfig(config, {
    maxTokens: 250,
    isToolCalling: true,  // ä½¿ç”¨å°æ¨¡å‹
  });

  // 2. æå–å·¥ä»¶å†…å®¹
  const currentArtifactContent = state.artifact
    ? getArtifactContent(state.artifact)
    : undefined;

  const artifactContent = currentArtifactContent
    ? isArtifactMarkdownContent(currentArtifactContent)
      ? currentArtifactContent.fullMarkdown
      : currentArtifactContent.code
    : undefined;

  // 3. è·å–ç”¨æˆ·è®°å¿†
  const store = ensureStoreInConfig(config);
  const assistantId = config.configurable?.assistant_id;
  const memories = await store.get(["memories", assistantId], "reflection");
  const memoriesAsString = memories?.value
    ? formatReflections(memories.value as Reflections, { onlyContent: true })
    : "No reflections found.";

  // 4. æ ¼å¼åŒ–å¯¹è¯å†å²
  const conversation = state._messages
    .map((msg) => `<${msg.getType()}>\n${msg.content}\n</${msg.getType()}>`)
    .join("\n\n");

  // 5. ç”Ÿæˆæç¤ºè¯å¹¶è°ƒç”¨AI
  const formattedPrompt = FOLLOWUP_ARTIFACT_PROMPT
    .replace("{artifactContent}", artifactContent || "No artifacts generated yet.")
    .replace("{reflections}", memoriesAsString)
    .replace("{conversation}", conversation);

  const response = await smallModel.invoke([
    { role: "user", content: formattedPrompt },
  ]);

  // 6. è¿”å›æ¶ˆæ¯åˆ°èŠå¤©å†å²
  return {
    messages: [response],
    _messages: [response],
  };
};
```

#### 5.1.3 è¾“å‡ºç»“æœ
- **å†…å®¹**: 2-3å¥ç®€çŸ­çš„å®Œæˆæç¤ºæ¶ˆæ¯
- **å»å‘**: å·¦ä¾§èŠå¤©æ¡†ï¼ˆç”± `langgraphNode === "generateFollowup"` å†³å®šï¼‰
- **ç‰¹ç‚¹**: ä¸ªæ€§åŒ–ã€ä¸Šä¸‹æ–‡ç›¸å…³ã€å‹å¥½æ­£å¼çš„è¯­è°ƒ

### 5.2 å…¶ä»–æ ¸å¿ƒèŠ‚ç‚¹å‚æ•°æ¦‚è§ˆ

#### 5.2.1 generateArtifact èŠ‚ç‚¹
**ä¸»è¦å‚æ•°**:
- `messages`: ç”¨æˆ·çš„åˆ›å»ºè¯·æ±‚
- `reflections`: ç”¨æˆ·åå¥½è®°å¿†
- `webSearchResults`: å¯é€‰çš„æœç´¢ç»“æœ

**è¾“å‡º**: æ–°çš„å·¥ä»¶å†…å®¹ â†’ å³ä¾§ç¼–è¾‘å™¨

#### 5.2.2 updateArtifact èŠ‚ç‚¹  
**ä¸»è¦å‚æ•°**:
- `messages`: ç”¨æˆ·çš„ä¿®æ”¹æŒ‡ä»¤
- `highlightedCode`: é€‰ä¸­çš„ä»£ç èŒƒå›´
- `artifact`: å½“å‰å·¥ä»¶çŠ¶æ€

**è¾“å‡º**: æ›´æ–°åçš„å·¥ä»¶å†…å®¹ â†’ å³ä¾§ç¼–è¾‘å™¨

#### 5.2.3 rewriteArtifact èŠ‚ç‚¹
**ä¸»è¦å‚æ•°**:
- `messages`: ç”¨æˆ·çš„é‡å†™è¯·æ±‚  
- `artifact`: ç°æœ‰å·¥ä»¶å®Œæ•´ç»“æ„
- `reflections`: ç”¨æˆ·åå¥½è®°å¿†

**è¾“å‡º**: é‡å†™åçš„å·¥ä»¶å†…å®¹ â†’ å³ä¾§ç¼–è¾‘å™¨

#### 5.2.4 replyToGeneralInput èŠ‚ç‚¹
**ä¸»è¦å‚æ•°**:
- `messages`: ç”¨æˆ·çš„èŠå¤©æ¶ˆæ¯
- `artifact`: å½“å‰å·¥ä»¶ï¼ˆä½œä¸ºä¸Šä¸‹æ–‡å‚è€ƒï¼‰
- `reflections`: ç”¨æˆ·è®°å¿†

**è¾“å‡º**: èŠå¤©å›å¤ â†’ å·¦ä¾§èŠå¤©æ¡†

## 6. è¯·æ±‚æ•°æ®ç»“æ„è¯¦è§£
```typescript
interface StreamConfig {
  threadId: string;           // ä¼šè¯çº¿ç¨‹ID
  assistantId: string;        // AIåŠ©æ‰‹ID
  input: GraphInput;          // è¾“å…¥æ•°æ®ï¼ˆè¯¦è§ä¸‹æ–¹ï¼‰
  modelName: string;          // æ¨¡å‹åç§°
  modelConfigs: Record<string, CustomModelConfig>; // æ¨¡å‹é…ç½®
}

interface GraphInput {
  messages?: Record<string, any>[];    // æ¶ˆæ¯å†å²
  
  // é«˜äº®é€‰æ‹©ç›¸å…³
  highlightedCode?: CodeHighlight;     // é«˜äº®çš„ä»£ç ç‰‡æ®µ
  highlightedText?: TextHighlight;     // é«˜äº®çš„æ–‡æœ¬ç‰‡æ®µ
  
  // å½“å‰å·¥ä»¶
  artifact?: ArtifactV3;               // å½“å‰ç¼–è¾‘çš„å·¥ä»¶
  
  // è·¯ç”±æ§åˆ¶
  next?: string;                       // ä¸‹ä¸€ä¸ªæ‰§è¡ŒèŠ‚ç‚¹
  
  // å†…å®¹ç”Ÿæˆæ§åˆ¶å‚æ•°
  language?: LanguageOptions;          // ç›®æ ‡è¯­è¨€
  artifactLength?: ArtifactLengthOptions; // å†…å®¹é•¿åº¦
  regenerateWithEmojis?: boolean;      // æ˜¯å¦æ·»åŠ è¡¨æƒ…ç¬¦å·
  readingLevel?: ReadingLevelOptions;  // é˜…è¯»éš¾åº¦çº§åˆ«
  
  // ä»£ç ç›¸å…³å‚æ•°
  addComments?: boolean;               // æ˜¯å¦æ·»åŠ æ³¨é‡Š
  addLogs?: boolean;                   // æ˜¯å¦æ·»åŠ æ—¥å¿—
  portLanguage?: ProgrammingLanguageOptions; // è½¬æ¢ç›®æ ‡ç¼–ç¨‹è¯­è¨€
  fixBugs?: boolean;                   // æ˜¯å¦ä¿®å¤bug
  
  // è‡ªå®šä¹‰å¿«æ·æ“ä½œ
  customQuickActionId?: string;        // è‡ªå®šä¹‰å¿«æ·æ“ä½œID
  
  // ç½‘ç»œæœç´¢
  webSearchEnabled?: boolean;          // æ˜¯å¦å¯ç”¨ç½‘ç»œæœç´¢
  webSearchResults?: SearchResult[];   // æœç´¢ç»“æœ
}
```

**æ•°æ®å­—æ®µæ¥æº**:
- `messages`: ä»å‰ç«¯èŠå¤©ç•Œé¢çš„æ¶ˆæ¯å†å²è·å–
- `highlightedCode/highlightedText`: ç”¨æˆ·åœ¨ç¼–è¾‘å™¨ä¸­é€‰ä¸­çš„å†…å®¹
- `artifact`: å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–‡æ¡£/ä»£ç å·¥ä»¶
- `modelName`: ç”¨æˆ·åœ¨å‰ç«¯æ¨¡å‹é€‰æ‹©å™¨ä¸­é€‰æ‹©çš„æ¨¡å‹
- `assistantId`: ä»å‰ç«¯åŠ©æ‰‹ä¸Šä¸‹æ–‡è·å–
- å…¶ä»–å‚æ•°: ä»å‰ç«¯çš„å¿«æ·æ“ä½œæŒ‰é’®ã€è®¾ç½®é¢æ¿ç­‰UIç»„ä»¶è·å–

**å“åº”æ•°æ®ç»“æ„**:
æµå¼å“åº”è¿”å›ä¸€ç³»åˆ—äº‹ä»¶ï¼Œæ¯ä¸ªäº‹ä»¶åŒ…å«ï¼š
```typescript
interface StreamEvent {
  event: "on_chat_model_stream" | "on_chain_start" | "on_chain_end" | "error";
  langgraphNode: string;      // å½“å‰æ‰§è¡Œçš„LangGraphèŠ‚ç‚¹
  nodeInput?: any;            // èŠ‚ç‚¹è¾“å…¥
  nodeChunk?: any;            // æµå¼å†…å®¹å—
  nodeOutput?: any;           // èŠ‚ç‚¹è¾“å‡º
  taskName?: string;          // ä»»åŠ¡åç§°
  runId?: string;             // è¿è¡ŒID
}
```

## 7. å“åº”å¤„ç†è¯¦è§£

### 7.1 æµå¼å“åº”å¤„ç†
å‰ç«¯é€šè¿‡ `GraphContext.tsx` ä¸­çš„ `streamMessageV2` å‡½æ•°å¤„ç†å“åº”ï¼š

#### 7.1.1 å“åº”äº‹ä»¶ç±»å‹åŠå¤„ç†

**`on_chat_model_stream` äº‹ä»¶**:
- **generateFollowup/replyToGeneralInput**: æ›´æ–°èŠå¤©æ¶ˆæ¯
- **generateArtifact**: å®æ—¶ç”Ÿæˆæ–°å·¥ä»¶å†…å®¹
- **updateArtifact**: æ›´æ–°é€‰ä¸­çš„ä»£ç ç‰‡æ®µ
- **updateHighlightedText**: æ›´æ–°é€‰ä¸­çš„æ–‡æœ¬ç‰‡æ®µ  
- **rewriteArtifact**: é‡å†™æ•´ä¸ªå·¥ä»¶å†…å®¹

**`on_chain_start` äº‹ä»¶**:
- **updateHighlightedText**: ä¿å­˜é«˜äº®æ–‡æœ¬ä¿¡æ¯
- **queryGenerator**: å¼€å§‹ç½‘ç»œæœç´¢ï¼Œæ˜¾ç¤ºæœç´¢çŠ¶æ€

**`on_chain_end` äº‹ä»¶**:
- **rewriteArtifact**: è·å–å·¥ä»¶å…ƒæ•°æ®ï¼ˆæ ‡é¢˜ã€ç±»å‹ã€è¯­è¨€ï¼‰
- **search**: å¤„ç†ç½‘ç»œæœç´¢ç»“æœ

#### 7.1.2 å®æ—¶å†…å®¹æ›´æ–°æœºåˆ¶

**å·¥ä»¶å†…å®¹æ›´æ–°**:
```typescript
// é€šè¿‡debounced setteré˜²æ­¢è¿‡äºé¢‘ç¹çš„æ›´æ–°
setArtifact((prev) => {
  return updateArtifactFunction(prev, newContent, artifactIndex);
});
```

**æ¶ˆæ¯å†å²æ›´æ–°**:
```typescript
setMessages((prevMessages) =>
  replaceOrInsertMessageChunk(prevMessages, messageChunk)
);
```

### 7.2 å†…å®¹åˆ†æµæœºåˆ¶è¯¦è§£

å‰ç«¯é€šè¿‡ **`langgraphNode`** å­—æ®µæ¥åŒºåˆ†è¿”å›å†…å®¹çš„å»å‘ï¼š

#### 7.2.1 å·¥ä»¶å†…å®¹æ›´æ–° (å³ä¾§ç¼–è¾‘å™¨)
è¿™äº›èŠ‚ç‚¹çš„è¾“å‡ºç›´æ¥æ›´æ–°å·¥ä»¶å†…å®¹ï¼š
```typescript
// å·¥ä»¶ç›¸å…³çš„èŠ‚ç‚¹
const ARTIFACT_NODES = [
  "generateArtifact",      // ç”Ÿæˆæ–°å·¥ä»¶
  "updateArtifact",        // æ›´æ–°ä»£ç ç‰‡æ®µ
  "updateHighlightedText", // æ›´æ–°æ–‡æœ¬ç‰‡æ®µ
  "rewriteArtifact",       // é‡å†™æ•´ä¸ªå·¥ä»¶
  "rewriteArtifactTheme",  // é‡å†™æ–‡æœ¬ä¸»é¢˜
  "rewriteCodeArtifactTheme" // é‡å†™ä»£ç åŠŸèƒ½
];

// å¤„ç†é€»è¾‘
if (ARTIFACT_NODES.includes(langgraphNode)) {
  // æ›´æ–° artifact çŠ¶æ€ï¼Œæ˜¾ç¤ºåœ¨å³ä¾§ç¼–è¾‘å™¨
  setArtifact(updatedArtifact);
}
```

#### 7.2.2 èŠå¤©æ¶ˆæ¯æ›´æ–° (å·¦ä¾§èŠå¤©æ¡†)
è¿™äº›èŠ‚ç‚¹çš„è¾“å‡ºæ·»åŠ åˆ°èŠå¤©å†å²ï¼š
```typescript
// èŠå¤©ç›¸å…³çš„èŠ‚ç‚¹
const CHAT_NODES = [
  "generateFollowup",      // ç”Ÿæˆå®Œæˆæç¤ºæ¶ˆæ¯
  "replyToGeneralInput"    // çº¯å¯¹è¯å›å¤
];

// å¤„ç†é€»è¾‘  
if (["generateFollowup", "replyToGeneralInput"].includes(langgraphNode)) {
  // æ›´æ–°æ¶ˆæ¯å†å²ï¼Œæ˜¾ç¤ºåœ¨å·¦ä¾§èŠå¤©æ¡†
  setMessages((prevMessages) =>
    replaceOrInsertMessageChunk(prevMessages, messageChunk)
  );
}
```

#### 7.2.3 "å·²å®Œæˆ"æç¤ºæ¶ˆæ¯çš„ç”Ÿæˆæµç¨‹

**åç«¯å·¥ä½œæµ**:
```
å·¥ä»¶æ“ä½œèŠ‚ç‚¹ â†’ generateFollowup â†’ èŠå¤©æ¡†æ˜¾ç¤º
     â†“              â†“
   æ›´æ–°å·¥ä»¶      ç”Ÿæˆå®Œæˆæç¤º
```

**generateFollowup è¯¦ç»†å‚æ•°**:
```typescript
// generateFollowup èŠ‚ç‚¹æ¥æ”¶çš„å‚æ•°
{
  // 1. å·¥ä»¶å†…å®¹ (æ ¸å¿ƒå‚æ•°)
  artifactContent: string | undefined,  // åˆšç”Ÿæˆ/æ›´æ–°çš„å·¥ä»¶å†…å®¹
  
  // 2. å¯¹è¯å†å² (ä¸Šä¸‹æ–‡å‚æ•°)
  conversation: string,  // å®Œæ•´çš„èŠå¤©è®°å½•ï¼Œæ ¼å¼åŒ–ä¸ºXML
  
  // 3. ç”¨æˆ·è®°å¿† (ä¸ªæ€§åŒ–å‚æ•°)
  reflections: string,   // ç”¨æˆ·åå¥½ã€é£æ ¼è§„åˆ™ç­‰è®°å¿†
  
  // 4. é…ç½®å‚æ•°
  maxTokens: 250,        // é™åˆ¶æç¤ºæ¶ˆæ¯é•¿åº¦
  modelType: "small"     // ä½¿ç”¨å°æ¨¡å‹ä»¥æé«˜å“åº”é€Ÿåº¦
}
```

**æ•°æ®è·å–è¿‡ç¨‹**:
1. **å·¥ä»¶å†…å®¹æå–**:
   ```typescript
   const currentArtifactContent = state.artifact 
     ? getArtifactContent(state.artifact) 
     : undefined;
   
   const artifactContent = currentArtifactContent
     ? isArtifactMarkdownContent(currentArtifactContent)
       ? currentArtifactContent.fullMarkdown  // æ–‡æœ¬å·¥ä»¶
       : currentArtifactContent.code          // ä»£ç å·¥ä»¶
     : undefined;
   ```

2. **å¯¹è¯å†å²æ ¼å¼åŒ–**:
   ```typescript
   const conversation = state._messages
     .map((msg) => `<${msg.getType()}>\n${msg.content}\n</${msg.getType()}>`)
     .join("\n\n");
   ```

3. **ç”¨æˆ·è®°å¿†æ£€ç´¢**:
   ```typescript
   const memories = await store.get(["memories", assistantId], "reflection");
   const memoriesAsString = memories?.value
     ? formatReflections(memories.value as Reflections, { onlyContent: true })
     : "No reflections found.";
   ```

**æç¤ºè¯æ¨¡æ¿è¯¦è§£**:
```typescript
const FOLLOWUP_ARTIFACT_PROMPT = `You are an AI assistant tasked with generating a followup to the artifact the user just generated.
The context is you're having a conversation with the user, and you've just generated an artifact for them. Now you should follow up with a message that notifies them you're done. Make this message creative!

<examples>
<example id="1">
Here's a comedic twist on your poem about Bernese Mountain dogs. Let me know if this captures the humor you were aiming for, or if you'd like me to adjust anything!
</example>
<example id="2">
Here's a poem celebrating the warmth and gentle nature of pandas. Let me know if you'd like any adjustments or a different style!
</example>
<example id="3">
Does this capture what you had in mind, or is there a different direction you'd like to explore?
</example>
</examples>

Here is the artifact you generated:
<artifact>
{artifactContent}          // ğŸ¯ åˆšç”Ÿæˆçš„å·¥ä»¶å†…å®¹
</artifact>

You also have the following reflections on general memories/facts about the user:
<reflections>
{reflections}              // ğŸ§  ç”¨æˆ·åå¥½å’Œè®°å¿†
</reflections>

Finally, here is the chat history between you and the user:
<conversation>
{conversation}             // ğŸ’¬ å®Œæ•´å¯¹è¯å†å²
</conversation>

This message should be very short. Never generate more than 2-3 short sentences. Your tone should be somewhat formal, but still friendly. Remember, you're an AI assistant.

Do NOT include any tags, or extra text before or after your response. Do NOT prefix your response. Your response to this message should ONLY contain the description/followup message.`;
```

**å…·ä½“å®ç°ç¤ºä¾‹**:
å‡è®¾ç”¨æˆ·è¯´ï¼š"å¸®æˆ‘å†™ä¸ªPythonè®¡ç®—å™¨"

1. **å·¥ä»¶å†…å®¹** (`artifactContent`):
   ```python
   def calculator():
       while True:
           try:
               expression = input("Enter calculation: ")
               if expression.lower() == 'quit':
                   break
               result = eval(expression)
               print(f"Result: {result}")
           except:
               print("Invalid expression")
   ```

2. **å¯¹è¯å†å²** (`conversation`):
   ```xml
   <human>
   å¸®æˆ‘å†™ä¸ªPythonè®¡ç®—å™¨
   </human>
   
   <ai>
   [å·¥å…·è°ƒç”¨ç”Ÿæˆä»£ç ...]
   </ai>
   ```

3. **ç”¨æˆ·è®°å¿†** (`reflections`):
   ```
   ç”¨æˆ·åå¥½ï¼š
   - å–œæ¬¢ç®€æ´æ˜äº†çš„ä»£ç 
   - ä¹ æƒ¯ä½¿ç”¨Pythonç¼–ç¨‹
   - é‡è§†ä»£ç çš„å®ç”¨æ€§å’Œå¯è¯»æ€§
   ```

4. **AIç”Ÿæˆçš„å®Œæˆæç¤º**:
   ```
   æˆ‘å·²ç»ä¸ºä½ åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„Pythonè®¡ç®—å™¨ï¼å®ƒæ”¯æŒåŸºæœ¬çš„æ•°å­¦è¿ç®—ï¼Œè¾“å…¥'quit'å¯ä»¥é€€å‡ºã€‚ä½ æƒ³è¦æˆ‘æ·»åŠ æ›´é«˜çº§çš„åŠŸèƒ½æˆ–æ”¹è¿›é”™è¯¯å¤„ç†å—ï¼Ÿ
   ```

**æ˜¾ç¤ºä½ç½®**: ç”±äº `langgraphNode === "generateFollowup"`ï¼Œè¾“å‡ºåˆ°èŠå¤©æ¡†

#### 7.2.4 æµå¼å¤„ç†çš„æ—¶åº

```typescript
// 1. å·¥ä»¶ç”Ÿæˆé˜¶æ®µ
if (langgraphNode === "generateArtifact") {
  // å®æ—¶æ›´æ–°å³ä¾§ç¼–è¾‘å™¨
  setArtifact(newArtifactContent);
}

// 2. å®Œæˆæç¤ºé˜¶æ®µ  
if (langgraphNode === "generateFollowup") {
  // æ·»åŠ åˆ°å·¦ä¾§èŠå¤©æ¡†
  setMessages(prev => [...prev, completionMessage]);
}
```

#### 7.2.5 å…³é”®ä»£ç ç‰‡æ®µ

**å‰ç«¯åˆ†æµé€»è¾‘**:
```typescript
if (event === "on_chat_model_stream") {
  // èŠå¤©æ¶ˆæ¯ - æ˜¾ç¤ºåœ¨å·¦ä¾§èŠå¤©æ¡†
  if (["generateFollowup", "replyToGeneralInput"].includes(langgraphNode)) {
    const message = extractStreamDataChunk(nodeChunk);
    setMessages((prevMessages) =>
      replaceOrInsertMessageChunk(prevMessages, message)
    );
  }
  
  // å·¥ä»¶å†…å®¹ - æ˜¾ç¤ºåœ¨å³ä¾§ç¼–è¾‘å™¨
  if (langgraphNode === "generateArtifact") {
    // å¤„ç†å·¥å…·è°ƒç”¨ï¼Œæ›´æ–°å·¥ä»¶
    setArtifact(processedArtifact);
  }
}
```

**åç«¯å·¥ä½œæµå®šä¹‰**:
```typescript
// æ‰€æœ‰å·¥ä»¶æ“ä½œéƒ½ä¼šè·¯ç”±åˆ° generateFollowup
.addEdge("generateArtifact", "generateFollowup")
.addEdge("updateArtifact", "generateFollowup") 
.addEdge("rewriteArtifact", "generateFollowup")
// ...

// çº¯èŠå¤©åˆ™ç›´æ¥ç»“æŸ
.addEdge("replyToGeneralInput", "cleanState")
```

### 7.3 é”™è¯¯å¤„ç†æœºåˆ¶
1. **æµå¼é”™è¯¯**: æ˜¾ç¤ºé”™è¯¯toastå¹¶åœæ­¢æµå¼å¤„ç†
2. **è®¤è¯é”™è¯¯**: è¿”å›401çŠ¶æ€ç ï¼Œå‰ç«¯é‡å®šå‘åˆ°ç™»å½•
3. **ç½‘ç»œé”™è¯¯**: é‡è¯•æœºåˆ¶å’Œé”™è¯¯æç¤º
4. **å·¥ä»¶æ›´æ–°å¤±è´¥**: è®¾ç½®`artifactUpdateFailed`çŠ¶æ€

## 8. è¾…åŠ©æ¥å£

### 8.1 ç”¨æˆ·åé¦ˆæ¥å£

**è¯·æ±‚è·¯å¾„**: `POST /api/runs/feedback`

**è¯·æ±‚æ•°æ®**:
```typescript
{
  runId: string;        // è¿è¡ŒID
  feedbackKey: string;  // åé¦ˆç±»å‹é”®
  score: number;        // è¯„åˆ†
  comment?: string;     // è¯„è®º
}
```

**å“åº”æ•°æ®**:
```typescript
{
  success: boolean;
  feedback: Feedback;
}
```

### 8.2 å­˜å‚¨æ“ä½œæ¥å£

**å­˜å‚¨å†™å…¥**: `POST /api/store/put`
```typescript
// è¯·æ±‚
{
  namespace: string;    // å‘½åç©ºé—´
  key: string;         // é”®
  value: any;          // å€¼
}

// å“åº”
{
  success: boolean;
}
```

**å­˜å‚¨è¯»å–**: `POST /api/store/get`
```typescript
// è¯·æ±‚
{
  namespace: string;
  key: string;
}

// å“åº”
{
  item: any;
}
```

### 8.3 è¯­éŸ³è½¬å½•æ¥å£

**è¯·æ±‚è·¯å¾„**: `POST /api/whisper/audio`

**è¯·æ±‚æ•°æ®**: FormData åŒ…å«éŸ³é¢‘æ–‡ä»¶

**å“åº”æ•°æ®**:
```typescript
{
  success: boolean;
  transcription: string;
}
```

### 8.4 ç½‘é¡µæŠ“å–æ¥å£

**è¯·æ±‚è·¯å¾„**: `POST /api/firecrawl/scrape`

**è¯·æ±‚æ•°æ®**:
```typescript
{
  urls: string[];       // è¦æŠ“å–çš„URLåˆ—è¡¨
}
```

**å“åº”æ•°æ®**:
```typescript
{
  success: boolean;
  documents: ContextDocument[];
}
```

## 8. æ ¸å¿ƒæ•°æ®ç±»å‹

### 8.1 å·¥ä»¶ç±»å‹ (ArtifactV3)
```typescript
interface ArtifactV3 {
  currentIndex: number;                    // å½“å‰å†…å®¹ç´¢å¼•
  contents: (ArtifactMarkdownV3 | ArtifactCodeV3)[]; // å†…å®¹åˆ—è¡¨
}

interface ArtifactMarkdownV3 {
  index: number;
  type: "text";
  title: string;
  fullMarkdown: string;
}

interface ArtifactCodeV3 {
  index: number;
  type: "code";
  title: string;
  language: ProgrammingLanguageOptions;
  code: string;
}
```

### 8.2 é«˜äº®ç±»å‹
```typescript
interface CodeHighlight {
  startCharIndex: number;     // å¼€å§‹å­—ç¬¦ç´¢å¼•
  endCharIndex: number;       // ç»“æŸå­—ç¬¦ç´¢å¼•
}

interface TextHighlight {
  fullMarkdown: string;       // å®Œæ•´markdownæ–‡æœ¬
  markdownBlock: string;      // é«˜äº®çš„markdownå—
  selectedText: string;       // é€‰ä¸­çš„æ–‡æœ¬
}
```

## 9. å‰ç«¯æ ¸å¿ƒç»„ä»¶ä¸æ¥å£äº¤äº’

### 9.1 GraphContext (apps/web/src/contexts/GraphContext.tsx)
- **ä½œç”¨**: ç®¡ç†æ‰€æœ‰ä¸AIåç«¯çš„é€šä¿¡
- **æ ¸å¿ƒæ–¹æ³•**: `streamMessageV2()` - å‘èµ·æµå¼è¯·æ±‚
- **çŠ¶æ€ç®¡ç†**: æ¶ˆæ¯å†å²ã€å·¥ä»¶çŠ¶æ€ã€æµå¼çŠ¶æ€ç­‰

### 9.2 StreamWorkerService (apps/web/src/workers/graph-stream/)
- **ä½œç”¨**: åœ¨Web Workerä¸­å¤„ç†æµå¼é€šä¿¡ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
- **æ ¸å¿ƒæ–¹æ³•**: `streamData()` - å‘èµ·æµå¼è¯·æ±‚å¹¶å¤„ç†å“åº”

### 9.3 APIä»£ç†å±‚ (apps/web/src/app/api/[..._path]/route.ts)
- **ä½œç”¨**: ä»£ç†æ‰€æœ‰åˆ°LangGraphåç«¯çš„è¯·æ±‚
- **åŠŸèƒ½**: 
  - ç”¨æˆ·è®¤è¯éªŒè¯
  - è¯·æ±‚è½¬å‘åˆ°LangGraphæœåŠ¡å™¨
  - è‡ªåŠ¨æ³¨å…¥ç”¨æˆ·ä¼šè¯ä¿¡æ¯

## 10. åç«¯LangGraphå·¥ä½œæµ

### 10.1 ä¸»è¦èŠ‚ç‚¹
- `generatePath`: è·¯ç”±èŠ‚ç‚¹ï¼Œå†³å®šæ‰§è¡Œæµç¨‹
- `generateArtifact`: ç”Ÿæˆæ–°å·¥ä»¶
- `rewriteArtifact`: é‡å†™ç°æœ‰å·¥ä»¶
- `updateArtifact`: æ›´æ–°å·¥ä»¶çš„éƒ¨åˆ†å†…å®¹
- `replyToGeneralInput`: å›å¤ä¸€èˆ¬å¯¹è¯
- `generateFollowup`: ç”Ÿæˆåç»­å»ºè®®
- `webSearch`: ç½‘ç»œæœç´¢
- `reflect`: åæ€å’Œè®°å¿†å­˜å‚¨

### 10.2 æ‰§è¡Œæµç¨‹
```
ç”¨æˆ·è¾“å…¥ â†’ generatePath (è·¯ç”±) 
  â†“
[generateArtifact|rewriteArtifact|updateArtifact|replyToGeneralInput]
  â†“
generateFollowup (ç”Ÿæˆåç»­å»ºè®®)
  â†“
reflect (åæ€å’Œè®°å¿†)
  â†“
ç»“æŸ
```

## 11. ç¯å¢ƒé…ç½®

### 11.1 å‰ç«¯ç¯å¢ƒå˜é‡ (apps/web/.env)
```bash
NEXT_PUBLIC_SUPABASE_URL=         # Supabaseé¡¹ç›®URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=    # SupabaseåŒ¿åå¯†é’¥
NEXT_PUBLIC_API_URL=              # APIåŸºç¡€URL
LANGGRAPH_API_URL=                # LangGraphæœåŠ¡å™¨URL
```

### 11.2 åç«¯ç¯å¢ƒå˜é‡ (æ ¹ç›®å½• .env)
```bash
LANGCHAIN_API_KEY=                # LangSmith APIå¯†é’¥
OPENAI_API_KEY=                   # OpenAI APIå¯†é’¥
ANTHROPIC_API_KEY=                # Anthropic APIå¯†é’¥
GROQ_API_KEY=                     # Groq APIå¯†é’¥
FIRECRAWL_API_KEY=               # FireCrawl APIå¯†é’¥
```

## 12. æ›¿æ¢åç«¯çš„å…³é”®ç‚¹

å¦‚æœè¦æ›¿æ¢ç°æœ‰çš„LangGraphåç«¯ï¼Œéœ€è¦å®ç°ä»¥ä¸‹æ¥å£ï¼š

### 12.1 å¿…é¡»å®ç°çš„æ ¸å¿ƒæ¥å£
1. **æµå¼è¿è¡Œæ¥å£**: `POST /runs/{thread_id}/stream`
2. **çº¿ç¨‹ç®¡ç†**: åˆ›å»ºã€è·å–çº¿ç¨‹ä¿¡æ¯
3. **åŠ©æ‰‹ç®¡ç†**: åŠ©æ‰‹çš„åˆ›å»ºå’Œé…ç½®
4. **å­˜å‚¨æ¥å£**: `store.putItem()` å’Œ `store.getItem()`

### 12.2 éœ€è¦å¤„ç†çš„æ ¸å¿ƒåŠŸèƒ½
1. **æ¶ˆæ¯æµå¼å¤„ç†**: å®æ—¶è¿”å›AIç”Ÿæˆçš„å†…å®¹
2. **å·¥ä»¶ç”Ÿæˆ**: æ ¹æ®ç”¨æˆ·éœ€æ±‚ç”Ÿæˆmarkdownæˆ–ä»£ç 
3. **å·¥ä»¶ç¼–è¾‘**: æ”¯æŒé«˜äº®é€‰æ‹©ã€éƒ¨åˆ†æ›´æ–°ã€é‡å†™ç­‰æ“ä½œ
4. **ä¸Šä¸‹æ–‡ç®¡ç†**: ç»´æŠ¤å¯¹è¯å†å²å’Œç”¨æˆ·åå¥½
5. **å¤šæ¨¡å‹æ”¯æŒ**: æ”¯æŒä¸åŒAIæ¨¡å‹çš„åˆ‡æ¢

### 12.3 æ•°æ®æ ¼å¼å…¼å®¹æ€§
- è¾“å…¥æ ¼å¼å¿…é¡»å…¼å®¹ `GraphInput` æ¥å£
- è¾“å‡ºæ ¼å¼å¿…é¡»å…¼å®¹ç°æœ‰çš„æµå¼äº‹ä»¶æ ¼å¼
- å·¥ä»¶æ ¼å¼å¿…é¡»å…¼å®¹ `ArtifactV3` ç»“æ„

## 13. è°ƒè¯•å’Œå¼€å‘å»ºè®®

### 13.1 æœ¬åœ°å¼€å‘å¯åŠ¨é¡ºåº
1. å¯åŠ¨LangGraphæœåŠ¡: `cd apps/agents && yarn dev`
2. å¯åŠ¨å‰ç«¯æœåŠ¡: `cd apps/web && yarn dev`
3. ç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®é…ç½®

### 13.2 å…³é”®è°ƒè¯•ç‚¹
- æ£€æŸ¥ `LANGGRAPH_API_URL` é…ç½®æ˜¯å¦æ­£ç¡®
- éªŒè¯ç”¨æˆ·è®¤è¯çŠ¶æ€
- ç›‘æ§æµå¼äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹
- æ£€æŸ¥å·¥ä»¶çŠ¶æ€çš„åŒæ­¥

è¿™ä¸ªæ–‡æ¡£ä¸ºä½ æä¾›äº†å®Œæ•´çš„å‰åç«¯æ¥å£è§„èŒƒï¼Œå¯ä»¥ä½œä¸ºæ›¿æ¢åç«¯å®ç°çš„å‚è€ƒä¾æ®ã€‚