# 图片403问题解决方案

## 问题描述
引用站外图片时出现403错误，这通常是由于目标网站的防盗链机制导致的。当浏览器请求外部图片时，会发送referrer信息，某些网站会检查referrer来阻止非授权的图片访问。

## 解决方案

### 1. Next.js配置优化
在 `next.config.mjs` 中添加了图片相关配置：
- 允许所有外部域名的图片
- 禁用图片优化以避免某些外部图片加载问题
- 添加图片代理重写规则

### 2. 图片代理API
创建了 `/api/proxy-image` 接口来代理外部图片请求：
- 服务端获取图片，避免浏览器直接请求
- 设置正确的请求头，包括User-Agent和Referrer-Policy
- 支持图片缓存，提高性能
- 安全验证，只允许HTTP/HTTPS协议

### 3. 图片代理工具函数
创建了 `lib/image-proxy.ts` 工具函数：
- `getProxyImageUrl()`: 将外部图片URL转换为代理URL
- `needsProxy()`: 检查是否需要代理
- `batchProxyImageUrls()`: 批量处理图片URL

### 4. 组件更新
更新了以下组件使用图片代理：
- `ToolCallRendererXhsSearch`: 小红书搜索结果图片
- `attachment.tsx`: 附件预览图片
- `attachment-ui.tsx`: UI组件图片

### 5. 关键技术点
- 使用 `referrerPolicy="no-referrer"` 属性
- 服务端代理请求避免CORS问题
- 正确的请求头设置
- 图片缓存策略

## 使用方法

### 基本用法
```tsx
import { getProxyImageUrl } from '@/lib/image-proxy'

// 在组件中使用
<img 
  src={getProxyImageUrl(originalImageUrl)} 
  referrerPolicy="no-referrer"
  alt="图片描述"
/>
```

### 批量处理
```tsx
import { batchProxyImageUrls } from '@/lib/image-proxy'

const imageUrls = ['http://example.com/image1.jpg', 'http://example.com/image2.jpg']
const proxyUrls = batchProxyImageUrls(imageUrls)
```

## 注意事项
1. 代理会增加服务器负载，建议添加适当的缓存策略
2. 某些图片可能仍然无法访问（如需要特殊认证的图片）
3. 大图片可能会影响加载速度，考虑添加图片压缩
4. 定期监控代理API的性能和错误率

## TODO
- [ ] 添加图片压缩功能
- [ ] 实现更智能的缓存策略
- [ ] 添加图片格式转换支持
- [ ] 监控代理API性能指标 